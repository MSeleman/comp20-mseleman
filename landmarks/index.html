<!DOCTYPE html>

<html>

	<head>
		<title>Geolocation Map Example</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="style.css" />
		<meta charset="utf-8">
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>
		<!-- <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB6G5DzhxTBUWyUl1l4rtUCH4shvbsf8LM&callback=init"
		 async defer> </script> -->
		<script>
			var map;
			var marker;
			var lat = 0;
			var lng = 0;
			var infowindow = new google.maps.InfoWindow();
			var me;
			var request = new XMLHttpRequest();
			var url = "https://defense-in-derpth.herokuapp.com/sendLocation"
			var parameters =  "login=jQsdAWji&lat=";
			var markers_list = [];
			var image = "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png";

			
			request.open("POST", url, true);
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			
			//init();
			getMyLocation();
			map.zoomControl = true;

			request.onreadystatechange = function (){

				if(request.readyState == 4 && request.status == 200){
					console.log("readystate");
					var rawData = request.responseText;
					var messages; //creates javascript objects 
				


					if( rawData != undefined){
				
						messages = JSON.parse(rawData);
						console.log(messages);
			
					}

					console.log("length: ");
					console.log(messages.people[0].lat	);
					console.log(messages.people.length);
					for (count = 0; count < messages.people.length; count++){

						setLocation(messages.people[count].lat, messages.people[count].lng, messages.people[count].login);

					}

				}
			}

			


      		function getMyLocation(){

      			console.log("getMyLoc");
      			if(navigator.geolocation) {

      				navigator.geolocation.getCurrentPosition(function(pos) {
      					lat = pos.coords.latitude;
      					lng = pos.coords.longitude;
      				

      					parameters += lat;
						parameters += "&lng=";
						parameters += lng;
						
						request.send(parameters);
						
						init();
      					setLocation(lat, lng, "Me");
      				});
      			}
      		}

      		function init() {
      			console.log("init");
       			map = new google.maps.Map(document.getElementById("map"), {
         		center: {lat: lat, lng: lng},
        		zoom: 10, 
        		zoomControl: true,
        		disableDefaultUI: false
       	 		});
      		}

      		function setLocation(latitude, longitude, info) {
      			console.log("setLoc");
      			me = new google.maps.LatLng(latitude, longitude);

      			map.panTo(me);
      			
      			markers_list.push(latitude);
      			markers_list.push(longitude);

      			for (i = 0; i < markers_list.length - 2; i += 2){
      				//console.log(markers_list[i]); 
      				marker = new google.maps.Marker({
      					position:{lat: markers_list[i], lng: markers_list[i+1]},
      					map: map,
      					title: info,
      					icon: image
      				});

      				console.log(marker.title);
      				
      				google.maps.event.addListener(marker, 'click', function (){
							console.log("herw");
							infowindow.setContent(marker.title);
							infowindow.open(map, marker);

      				});

      				marker.setMap(map);
      			}
      		}

      			//onload="init()"
   		</script>

	</head>
	
	<body> 
		<div id="map"></div>
	</body>
</html>
