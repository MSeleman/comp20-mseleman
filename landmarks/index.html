<!DOCTYPE html>

<html>

	<head>
		<title>Geolocation Map Example</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="style.css" />
		<meta charset="utf-8">
		<!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script> -->
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=false"></script>
		<!-- <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB6G5DzhxTBUWyUl1l4rtUCH4shvbsf8LM&callback=init"
		 async defer> </script> -->
		<script>
			var map;
			var marker;
			var lat = 0;
			var lng = 0;
			var infowindow = new google.maps.InfoWindow();
			var me;
			var request = new XMLHttpRequest();
			var url = "https://defense-in-derpth.herokuapp.com/sendLocation"
			var parameters =  "login=jQsdAWji&lat=";
			var markers_list = [];
			var image3 = "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png";
			var image2 = "if_map_pin_alt_118703 (1).svg";
			var image = "hello.svg";
			var image4 = "if_map-marker_299087 (1).svg";

			
			request.open("POST", url, true);
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			
			//init();
			getMyLocation();
			me = new google.maps.LatLng(lat, lng);
	

			request.onreadystatechange = function (){

				if(request.readyState == 4 && request.status == 200){
					console.log("readystate");
					var rawData = request.responseText;
					var messages; //creates javascript objects 
					var description;
					var my_loc =  new google.maps.LatLng(lat, lng);
					var other_loc;
				


					if( rawData != undefined){
				
						messages = JSON.parse(rawData);
						console.log(messages);
			
					}

					for (count = 0; count < messages.people.length; count++){
						console.log("hello");

						other_loc = new google.maps.LatLng(messages.people[count].lat, messages.people[count].lng);

							description = "Login: ";
							description += messages.people[count].login;
							description +=  " ";
							description += "Distance: ";
							description += google.maps.geometry.spherical.computeDistanceBetween(my_loc, other_loc) / 1609.34;
							description += " mi";

						if(!(messages.people[count].login == "jQsdAWji" && 
										google.maps.geometry.spherical.computeDistanceBetween(my_loc, other_loc) == 0)){
							setLocation(messages.people[count].lat, messages.people[count].lng, description, image3);
						}	
					}

					// console.log("landmark length");
					// console.log(messages.landmarks.length);
					// console.log(messages.landmarks[0].geometry.coordinates[0]);
					// console.log(messages.landmarks[0].geometry.coordinates[1]);


					for (count = 0; count < messages.landmarks.length; count++){
						// console.log("in here");
						setLocation(messages.landmarks[count].geometry.coordinates[1], messages.landmarks[count].geometry.coordinates[0], messages.landmarks[count].properties.Details, image2);

					}

				}
			}


      		function getMyLocation(){

      			console.log("getMyLoc");
      			if(navigator.geolocation) {

      				navigator.geolocation.getCurrentPosition(function(pos) {
      					lat = pos.coords.latitude;
      					lng = pos.coords.longitude;
      				

      					parameters += lat;
						parameters += "&lng=";
						parameters += lng;
						console.log(parameters);

						request.send(parameters);

						console.log(lat);
						console.log(lng);

					
						init();
      					setLocation(lat, lng, "Me", image4);

      				});
      			}
      		}

      		function init() {
      			console.log("init");
       			map = new google.maps.Map(document.getElementById("map"), {
        			zoom: 20,
        			center: {lat: lat, lng: lng}
       	 		});

      		}


      		function setLocation(latitude, longitude, info, new_image) {
      			//console.log("setLoc");
      		
      			my_loc =  new google.maps.LatLng(lat, lng);

    	
      				marker = new google.maps.Marker({
      					position:{lat: latitude, lng: longitude},
      					map: map,
      					title: info,
      					icon: new_image
      				});
      				
      				google.maps.event.addListener(marker, 'click', function (){
      						console.log(this);

      						if(this.title == "Login: jQsdAWji Distance: 0 mi"){
      							console.log("its me");
      						}
							infowindow.setContent(info);
							infowindow.open(map, this);

      				}); 

      		
      		}

      			//onload="init()"
   		</script>

	</head>
	
	<body> 
		<div id="map"></div>
	</body>
</html>
